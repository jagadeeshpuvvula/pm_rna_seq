---
title: "07_mediation_analysis"
author: "Jagadeesh Puvvula"
date: "2024-12-29"
output: pdf_document
---

#Clean RNAseq, exposure, covariate data
```{r}
load("~/Documents/air_polln_rna_seq/results/for_mediation_analy.rda")

#excluding smokers
df_analysis<- df_analysis |>
  filter(tobacco_use_dur_preg == "No")
```

#filter genes significantly associated with exposures
```{r}
#filtered genes that are significantly associated with air pollution
all_results<- read_csv("~/Documents/air_polln_rna_seq/results/pm_bc_twas_april_11.csv") |>
  mutate(
    predictor_numeric = ifelse(grepl("_all$", predictor_variable), "Overall", 
                              as.numeric(gsub(".*_([0-9]+)$", "\\1", predictor_variable))),
    predictor_numeric = factor(predictor_numeric, levels = c("Overall", "1", "2", "3", "4", "5")),
    predictor_prefix = substr(predictor_variable, 1, 2),
    predictor_prefix = if_else(predictor_prefix == "pm", "PM2.5", "Black Carbon")
  ) |>
  filter(FDR < 0.2,
         predictor_prefix == "Black Carbon") ## Update this line

#match number of genes including in the analysis
n_distinct(all_results$gene_symbol) # should be 50 for PM and 63 for BC

rna_seq_med <- transcriptome_clean |>
  as.data.frame() |>
  rownames_to_column(var = "gene") |>
  filter(gene %in% all_results$gene) |>
  t() |>
  as.data.frame() 

# Set the first row as column names and remove it from the data
colnames(rna_seq_med) <- rna_seq_med[1, ]
rna_seq_med <- rna_seq_med[-1, , drop = FALSE] 

#scaling rna seq values
rna_seq_med_z <- rna_seq_med |>
  mutate(across(everything(), ~ {
    x <- as.numeric(.)
    (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }))
```

#Metabolome data
```{r}
metabo_linkage <- read_csv("~/Documents/air_polln_rna_seq/crib_data/metabolome_paired/metabolome_linkage.csv") |>
  janitor::clean_names() |>
  dplyr::select(parent_sample_name, sample_description) |>
  dplyr::mutate(sample_description = sub("PCFSBDEB[1-4]$", "", sample_description))


placenta_metabo <- read_csv("~/Documents/air_polln_rna_seq/crib_data/metabolome_paired/metabolome_conc.csv") |>
  clean_names() |>
  left_join(metabo_linkage, by="parent_sample_name") |>
  mutate(sample_description = as.numeric(sample_description)) |> 
  rename(subject_id = sample_description) |> 
  select(subject_id, everything()) |>
  select(-c(2)) |>
  mutate(across(2:last_col(), ~ log10(. + 0.00001))) |>
  mutate(across(2:last_col(), ~ (. - mean(.)) / sd(.))) |>
  column_to_rownames("subject_id") |>
  #select(c("x100001755"))  #for pm2.5

  select(c("x49", "x280", "x1538", "x100006292", "x100001866")) #for BC

  
```

#combine RNA-seq and metabolite into a single matrix
```{r}
combined_df <- list(rna_seq_med_z, 
                    placenta_metabo, 
                    df_analysis) |>
  map(~ as_tibble(., rownames = "sample")) |>
  reduce(inner_join, by = "sample") |>
  column_to_rownames(var = "sample") |>
  mutate(ptb = as.factor(if_else(ptb == "Term", 0, 1)))
```

#mediation analysis
#alpha_hat: coefficient estimates of exposure (X) –> mediators (M) (adjusted for covariates).
#alpha_se: standard error for alpha.
#beta_hat: coefficient estimates of mediators (M) –> outcome (Y) (adjusted for covariates and exposure).
#beta_se: standard error for beta.
#IDE: mediation (indirect) effect, i.e., alpha*beta.
#rimp: relative importance of the mediator.
#pmax: joint raw p-value of selected significant mediator (based on divide-aggregate compositenull test [DACT] method).
```{r}
library(HIMA)

classicHima.fit <- hima_classic(
  X = as.numeric(combined_df$pm_days_5),
  Y = as.factor(combined_df$ptb),
  M = as.matrix(combined_df[1:51]),
  #COV.XM = as.matrix(combined_df[, c("ga_at_delivery", "maternal_age")]),
  #COV.MY = combined_df[, c("ga_at_delivery", "maternal_age")],
  penalty = c("SCAD"),
  Bonfcut = 0.2,
  Y.type = "binary",
  scale = T, 
  verbose = TRUE,
  parallel = T,
  ncore = 10
  )

classicHima.fit %>%
  mutate(
    across(where(is.numeric) & !matches("pmax"), ~ round(.x, 2)),
    pmax = formatC(pmax, format = "e", digits = 1)
  )

# Run the model
mod <- glm(ptb ~ pm_days_3, data = combined_df, family = binomial)

# Tidy, filter, and format the output
tidy(mod) %>%
  filter(term == "pm_days_3") %>%
  mutate(
    estimate = round(estimate, 2),
    std.error = round(std.error, 2),
    statistic = round(statistic, 2),
    p.value = formatC(p.value, format = "e", digits = 2)
  )
```

#automating
```{r}
#define comparision group
df_analysis$ptb <- relevel(df_analysis$ptb, ref = "Term")

# Initialize empty dataframe
final_results <- data.frame()

for (i in 1:141) {
  pm_col <- paste0("pm_", i)
  
  tryCatch({
    print(paste("Processing:", pm_col))
    
    result <- hima_classic(
      X = as.numeric(df_analysis[[pm_col]]),
      Y = as.factor(df_analysis$ptb),
      M = combined_matrix,
      #COV.XM = df_analysis[, c("ga_at_delivery", "maternal_age")],
      penalty = c("lasso"),
      Y.type = "binary",
      M.type = "gaussian",
      Bonfcut = 0.05,
      scale = TRUE,
      verbose = TRUE,
      parallel = TRUE,
      ncore = 10
    )
    
    print("Result structure:")
    print(str(result))
    
    # If the result is not null and contains data, process it
    if (!is.null(result) && nrow(result) > 0) {
      print("Full result:")
      print(result)
      
      # Convert result to dataframe
      result_df <- as.data.frame(result)
      
      # Add the pm_variable column
      result_df$pm_variable <- pm_col
      
      # Append to final_results
      if (nrow(final_results) == 0) {
        final_results <- result_df
      } else {
        final_results <- rbind(final_results, result_df)
      }
      
      print("Current final_results dimensions:")
      print(dim(final_results))
    } else {
      print(paste("No valid data for", pm_col))
    }
    
    print(paste("Completed analysis for", pm_col))
    
  }, error = function(e) {
    message(paste("Error in", pm_col, ":", e$message))
  })
}
```

```{r}
write_csv(final_results, "~/Documents/air_polln_rna_seq/results/mediation_pm_log10_scale.csv")
```

#visualizing mediation results
```{r}
med_res_bc<- read_csv("~/Documents/air_polln_rna_seq/results/mediation_bc_log10_scale.csv") |>
  mutate(air_pol = "black carbon")

med_res_pm<- read_csv("~/Documents/air_polln_rna_seq/results/mediation_pm_log10_scale.csv")|>
  mutate(air_pol = "PM2.5")

#filtered results where 
mediation_res<- bind_rows(med_res_bc, med_res_pm) |>
  filter(pmax < 0.001) |>
  mutate(OR = exp(beta_hat)) |>
  mutate(across(c(alpha_hat, beta_hat, IDE, OR), \(x) if(is.numeric(x)) round(x, 2) else x))|>
  mutate(pmax = formatC(pmax, format = "e", digits = 1)) |>
  #filter(OR<10) |>
  group_by(Index) |>
  select(c(8,7,1,2:4,6,9,5)) 

rm(med_res_bc, med_res_pm)

#There are 16 genes with FDR < 0.1% among these 5 are protective (3 related to BC and 2 - PM)
#these genes with protective odds are of smaller magnitude range between 0.2-0.4
#11 genes with higher odds for PTB are at higher magnitude (6 related to BC and 5 - PM), odds ratios ranged between 1.6-23.9
#export results file
write_csv(mediation_res, "~/Documents/air_polln_rna_seq/results/mediation_results_for_supplment.csv")


#
#visualization
mediation_plt<- mediation_res |>
  filter(n() > 1) |>
  ungroup() 

```

#cmaverse - Attempt on April 15
```{r}
library(CMAverse)
```

```{r}
res_iorw <- cmest(data = combined_df, 
                 model = "rb", 
                 outcome = "ptb",
                 exposure = "bc_days_4",
                 mediator = c("ENSG00000235162", "ENSG00000163492", 
                              "ENSG00000175315", "ENSG00000169429"), 
                 basec = c("ga_at_delivery", "parity"), 
                 EMint = F,
                 mreg = list("linear", "linear", "linear", "linear"),  # All mediators are continuous z-scores
                 yreg = "logistic",  # Binary outcome
                 astar = 5, a = 20, 
                 mval = list(0, 0, 0, 0), 
                 estimation = "imputation", 
                 inference = "bootstrap", nboot = 20)

summary(res_iorw)
```

#single mediation analysis
```{r}
library(mediation)

combined_df <- combined_df |>
  dplyr::mutate(ptb = factor(ptb))  # ensure it's a factor

# Relevel
combined_df$ptb <- relevel(combined_df$ptb, ref = "0")

# Mediator model
med_model <- lm(ENSG00000005381 ~ ptb + 
                  race + bmi + education + tobacco_use_dur_preg + parity,
                data = combined_df)

# Outcome model
out_model <- lm(bc_days_3 ~ ptb + ENSG00000005381 + 
                  race + bmi + education + tobacco_use_dur_preg + parity,
                data = combined_df)

# Mediation
med_results <- mediate(med_model, out_model, 
                       treat = "ptb", 
                       mediator = "ENSG00000005381", 
                       boot = TRUE, sims = 1000,
                       conf.level = .80)

s <- summary(med_results)

med_table <- tibble(
  Term = c("ACME", "ADE", "Total Effect", "Proportion Mediated"),
  Estimate = c(s$d0, s$z0, s$tau.coef, s$n0),
  CI_Lower = c(s$d0.ci[1], s$z0.ci[1], s$tau.ci[1], s$n0.ci[1]),
  CI_Upper = c(s$d0.ci[2], s$z0.ci[2], s$tau.ci[2], s$n0.ci[2]),
  p_value = c(s$d0.p, s$z0.p, s$tau.p, s$n0.p)
) |>
  mutate(
    Estimate = round(Estimate, 2),
    CI_Lower = round(CI_Lower, 2),
    CI_Upper = round(CI_Upper, 2),
    p_value = round(p_value, 3),
    Formatted = paste0(Estimate, " (", CI_Lower, ", ", CI_Upper, ")")
  ) |>
  dplyr::select(Term, Formatted, p_value)

med_table


```

